name: Deploy Next.js to Digital Ocean

on:
  workflow_dispatch:  # This line creates the button

  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [ closed ]

    
jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Validate deployment secrets
        run: |
          if [ -z "${{ secrets.DEPLOY_HOST }}" ]; then
            echo "‚ùå DEPLOY_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.DEPLOY_USER }}" ]; then
            echo "‚ùå DEPLOY_USER secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.DEPLOY_KEY }}" ]; then
            echo "‚ùå DEPLOY_KEY secret is not set"
            exit 1
          fi
          echo "‚úÖ All required deployment secrets are set"
         
      - name: Deploy to Digital Ocean
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: 22
          script: |
            cd /var/www/sarai-imv2

            echo "üöÄ Starting deployment..."


            pm2 stop sarai-imv2 || true
            pm2 delete sarai-imv2 || true

            # Pull latest code
            git pull origin main
            
            # Install production dependencies
            npm ci --only=production
            
            # Build application
            npm run build
            
            
            # Restart using ecosystem config
            pm2 start ecosystem.config.js
            pm2 save
            
            echo "‚úÖ Deployment complete"
